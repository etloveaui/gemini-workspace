# ğŸ¯ í‘œì¤€ GitHub Actions ì›Œí¬í”Œë¡œ í…œí”Œë¦¿ v1.0
# ë©€í‹° ì—ì´ì „íŠ¸ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ìš© í‘œì¤€í™”ëœ CI/CD

name: Standard Multi-Agent Workflow

# ğŸ”§ íŠ¸ë¦¬ê±° ì„¤ì • (í‘œì¤€í™”)
on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ë³´ì¥ (í•„ìˆ˜)
    inputs:
      environment:
        description: 'Environment to deploy'
        required: false
        default: 'production'
        type: choice
        options:
        - development
        - staging
        - production
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main, develop ]
    # ê²½ë¡œ ìµœì†Œí™” - ê³¼ë„í•œ ê¸€ë¡­ íŒ¨í„´ ë°©ì§€
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [ main ]

# ğŸ”’ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆ ê°•í™”)
permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  # í•„ìš”ì‹œ ì¶”ê°€: issues: write, deployments: write

# ğŸŒ í™˜ê²½ ë³€ìˆ˜ (í‘œì¤€í™”)
env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  WORKSPACE_ENCODING: 'utf-8'

jobs:
  # ğŸ“‹ í™˜ê²½ ê²€ì¦ (Preflight Doctor v2.0 í™œìš©)
  preflight-check:
    runs-on: windows-latest
    name: ğŸ¥ Environment Validation
    outputs:
      python-version: ${{ steps.setup.outputs.python-version }}
      workspace-ready: ${{ steps.doctor.outputs.workspace-ready }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        id: setup
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Preflight Doctor v2.0
        id: doctor
        shell: pwsh
        run: |
          try {
            $result = python scripts/doctor.py
            echo "workspace-ready=true" >> $env:GITHUB_OUTPUT
            Write-Host "âœ… Preflight check passed" -ForegroundColor Green
          } catch {
            echo "workspace-ready=false" >> $env:GITHUB_OUTPUT
            Write-Host "âŒ Preflight check failed: $_" -ForegroundColor Red
            exit 1
          }

  # ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ 
  test:
    needs: preflight-check
    if: needs.preflight-check.outputs.workspace-ready == 'true' && !inputs.skip_tests
    runs-on: windows-latest
    name: ğŸ§ª Test Execution
    strategy:
      matrix:
        test-group: [unit, integration, system]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.preflight-check.outputs.python-version }}

      - name: Install test dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist

      - name: Run ${{ matrix.test-group }} tests
        shell: pwsh
        run: |
          # Windows ì¸ì½”ë”© ë¬¸ì œ í•´ê²°
          $env:PYTHONIOENCODING = "utf-8"
          $env:PYTHONUTF8 = "1"
          
          # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê·¸ë£¹ë³„)
          switch ("${{ matrix.test-group }}") {
            "unit" { pytest tests/unit/ -v --cov=src --cov-report=xml }
            "integration" { pytest tests/integration/ -v --tb=short }
            "system" { pytest tests/system/ -v --tb=line }
          }

      - name: Upload coverage reports
        if: matrix.test-group == 'unit'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # ğŸš€ ë°°í¬ (ì¡°ê±´ë¶€)
  deploy:
    needs: [preflight-check, test]
    if: github.ref == 'refs/heads/main' && needs.preflight-check.outputs.workspace-ready == 'true'
    runs-on: windows-latest
    name: ğŸš€ Deployment
    environment: ${{ inputs.environment || 'production' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to ${{ inputs.environment || 'production' }}
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Deploying to ${{ inputs.environment || 'production' }}" -ForegroundColor Cyan
          # ë°°í¬ ë¡œì§ì„ ì—¬ê¸°ì— ì¶”ê°€
          
  # ğŸ“Š ê²°ê³¼ ì•Œë¦¼
  notify:
    needs: [preflight-check, test, deploy]
    if: always()
    runs-on: windows-latest
    name: ğŸ“Š Notification
    steps:
      - name: Workflow Summary
        shell: pwsh
        run: |
          $status = "${{ needs.deploy.result }}" -eq "success" ? "âœ… SUCCESS" : "âŒ FAILED"
          Write-Host "ğŸ¯ Workflow completed: $status" -ForegroundColor $(if ($status.Contains("SUCCESS")) { "Green" } else { "Red" })
          
          # ì—ì´ì „íŠ¸ ë¡œê¹… (ì„ íƒì‚¬í•­)
          if (Test-Path "logs/") {
            $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            "$timestamp - GitHub Actions: $status" | Out-File -Append -FilePath "logs/workflow.log"
          }