## **[GEMINI] Edit Reliability 작업 분석 보고서**

### **1. 분석 목표**

본 보고서는 Gemini CLI의 파일 수정 기능(`replace`, `write_file`)에서 반복적인 실패를 방지하고, 재시도 및 대체 메커니즘의 신뢰성을 높이기 위한 구체적인 구현 계획 수립을 목표로 합니다.

### **2. 핵심 파일 식별**

파일 수정, 도구 사용, 오류 처리 및 재시도 로직과 가장 관련 깊은 파일들은 일반적으로 다음과 같은 구조로 존재할 것으로 추정됩니다.

* **도구 정의 및 실행 (`tools/` 또는 `lib/`):**
    * `file_system_tools.py`: `replace`, `write_file`과 같은 실제 파일 시스템 조작 함수들이 정의된 파일일 가능성이 높습니다.
* **에이전트 로직 및 도구 호출 (`gemini/` 또는 `agent/`):**
    * `agent_executor.py` 또는 `task_handler.py`: 사용자 요청을 받아 어떤 도구를 사용할지 결정하고, 해당 도구의 실행을 관리하는 핵심 로직이 포함된 파일입니다. 파일 수정 도구의 호출 및 결과 처리가 이곳에서 이루어질 것입니다.
* **오류 처리 및 재시도 유틸리티 (`utils/` 또는 `common/`):**
    * `retry_utils.py` 또는 `error_handlers.py`: 재시도 로직(예: exponential backoff)을 위한 데코레이터나 헬퍼 함수가 위치할 수 있는 파일입니다.
* **CLI 인터페이스 (`scripts/` 또는 `cli/`):**
    * `cli.py` 또는 `main.py`: 커맨드 라인 인터페이스의 시작점으로, 에이전트 실행을 초기화하고 전반적인 성공/실패를 처리하는 코드가 포함될 수 있습니다.

### **3. 수정 대상 함수/클래스 분석 및 구현 전략**

#### **가. 제어 흐름 분석**

현재 제어 흐름은 다음과 같을 것으로 예상됩니다.

1.  **`cli.py`**: 사용자의 명령을 받아 `agent_executor` 객체를 생성하고 실행합니다.
2.  **`agent_executor.py`**: LLM의 추론 결과를 바탕으로 `file_system_tools.py`에 정의된 `replace` 또는 `write_file` 함수를 호출합니다.
3.  **현재 문제**: `agent_executor.py`에서 도구 호출이 실패하면, 별도의 상태 관리 없이 단순히 재시도를 수행하여 동일한 실패를 반복할 가능성이 있습니다.

#### **나. 구현 전략 제안**

**1. 중복 수정 식별 및 방지**

실패한 수정 요청을 단기간에 반복하지 않도록 막는 것이 중요합니다.

* **구현 위치**: `agent_executor.py` 내에서 도구를 호출하는 부분.
* **전략**: **메모리 내 캐시(In-memory Cache)** 사용을 제안합니다.
    * `dict` 형태의 캐시 객체를 `agent_executor` 클래스의 인스턴스 변수로 생성합니다.
    * 키(key)는 `(file_path, old_string, new_string)`과 같은 수정 요청의 핵심 파라미터를 조합한 튜플로 구성하고, 값(value)은 실패 시점의 타임스탬프(timestamp)로 설정합니다.
    * 도구 실행 전, 동일한 키가 캐시에 있고 마지막 실패로부터 일정 시간(예: 5분)이 지나지 않았다면, 재시도를 건너뛰고 즉시 실패 처리합니다. 이는 불필요한 반복을 막는 가장 효과적인 방법입니다.

**2. 백오프(Backoff) 메커니즘 구현**

재시도 사이에 점진적으로 대기 시간을 늘리는 백오프 로직을 도입해야 합니다.

* **구현 위치**: `utils/retry_utils.py`에 재시도 데코레이터를 만들고, `agent_executor.py`에서 도구를 호출하는 함수에 적용합니다.
* **전략**:
    * `tenacity`와 같은 라이브러리를 활용하거나 직접 데코레이터를 구현하여 **지수 백오프(Exponential Backoff)** 로직을 만듭니다.
    * 예시: `@retry(wait=wait_exponential(multiplier=1, min=2, max=60), stop=stop_after_attempt(3))`
    * 이 데코레이터를 `agent_executor.py` 내 파일 수정 도구를 호출하는 내부 메소드에 적용하면, 코드 변경을 최소화하면서 안정적인 재시도 정책을 구현할 수 있습니다.

**3. 통합 오류 보고**

분산된 로그를 중앙에서 관리하여 성공/실패를 일관되게 추적해야 합니다.

* **구현 위치**: `agent_executor.py`의 도구 실행 결과 처리 부분.
* **전략**:
    * 파일 수정 시도의 **성공, 실패, 그리고 중복 방지에 의해 건너뛴 경우**를 모두 구조화된 형식으로 로깅하는 함수를 만듭니다.
    * 이 로깅 함수는 **HUB와 같은 중앙 시스템에 보고**하는 로직을 포함해야 합니다.
    * 도구 실행 직후 `try...except...finally` 구문을 사용하여, 성공 여부와 관계없이 항상 이 로깅 함수가 호출되도록 보장하는 것이 중요합니다. 이곳이 모든 파일 수정 시도의 결과를 통합적으로 처리할 수 있는 최적의 지점입니다.

### **4. 잠재적 부작용 및 최소화 방안**

제안된 변경 사항은 다른 에이전트나 기존 테스트에 영향을 미칠 수 있습니다.

* **잠재적 부작용**:
    * **테스트 케이스 실패**: 재시도 및 백오프 로직의 도입으로 기존 테스트의 타임아웃(timeout) 시간이 초과될 수 있습니다.
    * **다른 에이전트 동작 변경**: 만약 다른 에이전트(예: Codex)가 동일한 도구 실행 모듈을 공유한다면, 해당 에이전트의 재시도 동작도 함께 변경될 수 있습니다.
* **최소화 방안**:
    * **기능 플래그(Feature Flag)**: 새로운 신뢰성 기능을 플래그로 제어하여, 문제가 발생할 경우 즉시 이전 방식으로 되돌릴 수 있도록 설계합니다.
    * **점진적 배포**: 변경 사항을 일부 사용자나 특정 워크플로우에 먼저 적용하여 안정성을 검증한 후 전체적으로 확대합니다.
    * **전용 테스트 케이스 추가**: 중복 수정 방지, 백오프 동작, 오류 보고가 정확히 의도대로 작동하는지 검증하는 새로운 단위 테스트 및 통합 테스트를 반드시 추가해야 합니다.

---

이 분석 보고서가 Gemini CLI의 신뢰성을 한 단계 높이는 데 기여하기를 바랍니다. 추가적인 분석이나 구체적인 코드 초안이 필요하시면 언제든지 요청해 주십시오.