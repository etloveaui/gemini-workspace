# 비상 절차 (임시)

## I. 치명적 오류 발생 시 대응

- **즉시 작업 중단**: 반복되는 치명적 오류(예: `SyntaxError`, 무한 대기) 발생 시, 더 이상 문제 해결을 시도하지 않고 즉시 작업을 중단한다.
- **상세 비상 로그 기록**: 현재까지의 모든 작업 내용, 발생한 문제, 시도했던 해결 방안, 현재 상태, 그리고 다음 단계(외부 도움 요청 등)를 포함하는 상세 비상 로그 파일을 `scratchpad/emergency_logs/` 디렉터리에 생성한다.
- **세션 안전 종료**: 비상 로그 기록 후, 가능한 모든 환경 정리(Git 상태, `.gitignore` 복원 등)를 시도하고 세션을 안전하게 종료한다.
- **외부 도움 요청**: 비상 로그를 기반으로 외부 전문가(다른 LLM 또는 사용자)에게 문제 해결을 위한 도움을 요청한다.

---

# Gemini 행동 지침 (gemini-workspace)

이 문서는 Gemini가 이 워크스페이스에서 작업을 수행할 때 따라야 할 최우선 규칙과 절차를 정의합니다.

---

## I. 핵심 운영 환경 (Core Operating Environment)

**-1. 메타인지 프로토콜 (Metacognition Protocol)**
1.  **사용자 명령 최우선:** 사용자가 "중단", "그만", "커밋해" 등 명시적인 작업 중단 또는 흐름 전환 명령을 내릴 경우, 진행 중인 모든 내부 목표(오류 수정, 코드 생성 등)를 **즉시 중단**하고 사용자 명령을 최우선으로 수행해야 한다.
2.  **실패 기록 의무:** 모든 도구 사용 실패(`command_error`)는 즉시 관련 `log.md`에 기록되어야 한다. 기록 없이는 다음 단계를 진행할 수 없다.
3.  **반복 행동 금지 (3-Strikes Rule):** 동일한 목표에 대해 동일한 도구(명령어)로 3회 연속 실패 시, 해당 접근법을 '실패'로 규정하고 즉시 중단한다.
4.  **대안 탐색 의무:** 3회 실패 후에는 사용자에게 상황을 보고하고, 문제의 근본 원인(예: "run_shell_command의 셸 파싱 문제")을 분석하며, `log.md`나 과거 Debug 문서를 참조하여 **다른 해결책을 먼저 제안**해야 한다.

**Error Matrix (오류 유형별 대응 방안)**

| 오류 유형 | 대응 방안 |
| :-------- | :-------- |
| 네트워크 실패 | 재시도 N회, 백오프, Proxy 확인 |
| 권한 실패 | 관리자 권한 체크, 파일 잠금 해제 스크립트 안내 |
| 외부 API 실패 | Mock fallback 또는 캐시된 데이터 사용 |
| 논리 오류 | 디버그 로그 분석, 관련 코드 섹션 재검토 |
| 로컬 IO 오류 | 파일 경로/권한 확인, 디스크 공간 확인 |

**1. 사용자 환경: Windows**
- **주 운영체제:** 이 워크스페이스의 주 운영체제는 **Windows** 입니다.
- **절대 준수:** 모든 파일 경로, 셸 명령어, 환경 변수 등은 Windows 표준을 따라야 합니다.

**2. Gemini의 실행 환경과 주의점**
- **환경 차이:** Gemini의 도구(Tool) 실행 환경은 Linux 기반일 수 있습니다. 이로 인해 Windows 명령어(`del`, `copy`) 대신 Linux 명령어(`rm`, `cp`)를 사용하려는 실수가 발생할 수 있습니다.
- **핵심 행동 규칙:** 모든 명령어 실행 전, **사용자 환경이 Windows임을 반드시 인지**하고 Windows에 맞는 명령어를 사용해야 합니다. 실패 시 OS 환경 차이를 가장 먼저 의심하고 수정합니다.

**3. 작업 공간 제한**
- **절대 원칙:** 모든 파일 작업은 `%USERPROFILE%\gemini-workspace` 디렉터리 안에서만 수행해야 합니다. 이 디렉터리 외부의 어떤 파일 시스템 경로에도 접근하거나 파일을 생성해서는 안 됩니다.

**4. 사용 언어**
- **기본 언어:** 사용자와의 모든 상호작용은 **한국어**로 진행하는 것을 원칙으로 합니다.

**5. Git 관리 폴더**
- **`projects/`:** 각 프로젝트는 별도의 Git 저장소로 관리되므로, 메인 워크스페이스 Git 저장소에서는 추적하지 않습니다. `.gitignore` 파일에서 `/projects/` 라인은 항상 유지되어야 합니다.
- **`scratchpad/`:** 임시 작업 및 테스트를 위한 공간으로, **항상 Git에 의해 추적되어야 합니다.** 이 폴더 내의 변경사항은 커밋에 포함될 수 있습니다. 따라서 `.gitignore` 파일에 `/scratchpad/` 라인이 존재해서는 안 됩니다.

**6. `docs/HELP.md` 및 `scripts/help.py`의 역할**
- **`docs/HELP.md`:** Gemini CLI의 사용법, 명령어, 문제 해결 팁 등을 사용자에게 제공하는 공식 도움말 문서입니다. 이 문서는 항상 최신 상태를 유지해야 하며, 사용자가 이해하기 쉬운 언어(기본 한국어)로 작성되어야 합니다.
- **`scripts/help.py`:** `docs/HELP.md` 파일을 파싱하여 사용자 요청에 따라 특정 섹션의 도움말을 CLI에 출력하는 스크립트입니다. 이 스크립트는 `docs/HELP.md`의 변경 사항을 정확하게 반영하고, 안정적으로 작동해야 합니다.

---

## II. 표준 작업 절차 (Standard Workflows)

**1. 세션 시작**
- 모든 대화 세션을 시작할 때, 이 `GEMINI.md` 파일을 가장 먼저 읽고 모든 규칙을 인지한 상태에서 작업을 시작해야 합니다.
- **시스템 초기 점검 및 브리핑:**
    - **환경 상태 확인:** `scripts/doctor.py`를 자동으로 실행하여 시스템 환경(Python, Git, venv 등) 및 필수 파일(`usage.db`, `.no_delete_list`, `GEMINI.md`)의 상태를 점검하고, 그 결과를 간결하게 브리핑합니다.
    - **활성/일시 중지된 작업 브리핑:** `docs/HUB.md`를 참조하여 현재 진행 중이거나 일시 중지된 작업 목록을 상세히 브리핑합니다. 각 작업에 대한 최근 로그 요약(예: `docs/tasks/[task_id]/log.md`의 마지막 3줄)을 포함하여 컨텍스트를 제공합니다.
    - **워크스페이스 변경 사항 요약:** `git status --porcelain`을 실행하여 커밋되지 않은 변경 사항이 있는지 확인하고, 그 상태를 브리핑합니다.
- **이전 세션 복구 제안:** `docs/HUB.md`에 `__lastSession__` 블록이 있는지 확인하고, 존재하면 사용자에게 해당 세션을 복구할지 여부를 질문한 후 해당 블록을 삭제합니다.
- **다음 행동 제안:** 위의 브리핑을 마친 후, 사용자에게 "어떤 작업을 계속할까요, 아니면 새로운 작업을 시작할까요? 시스템 상태를 점검하시겠습니까?"와 같이 다음 행동을 제안하여 대화의 흐름을 자연스럽게 유도합니다.

**2. `.gitignore` 관리**
- **`projects/` 폴더:** 각 프로젝트는 별도의 Git 저장소로 관리되므로, 메인 워크스페이스 Git 저장소에서는 추적하지 않습니다. `.gitignore` 파일에서 `/projects/` 라인은 **항상 유지**되어야 합니다. (작업 중 필요에 의해 주석을 해제하더라도, 작업 완료 시에는 반드시 주석을 제거하여 `/projects/` 라인이 활성화된 상태여야 합니다.)
- **`scratchpad/` 폴더:** 임시 작업 및 테스트를 위한 공간으로, Git에 의해 추적됩니다. 이 폴더 내의 변경사항은 커밋에 포함될 수 있습니다. 따라서 `.gitignore`에서 `/scratchpad/` 라인은 제거되어야 합니다.

**3. 민감 정보 처리**
- **핵심 파일:** `secrets/my_sensitive_data.md` (Git 추적 제외)
- **절차:**
    1. 새로운 민감 정보 발견/생성 시, 즉시 `secrets/my_sensitive_data.md` 파일에 명확한 형식으로 기록합니다.
    2. 기록 후, 사용자에게 **"새로운 [정보 종류] 정보를 `secrets/my_sensitive_data.md` 파일에 기록했습니다. 내용을 확인하고 안전하게 관리해 주세요."** 라고 즉시 알립니다.
    3. **경고:** 민감 정보 자체를 대화창에 절대 노출해서는 안 됩니다.

**4. Git 커밋 (Windows 환경)**
- **문제:** `git commit -m "메시지"` 명령어의 문자열 처리 문제.
- **우회 절차:**
    1. `COMMIT_MSG.tmp` 임시 파일에 커밋 메시지를 작성합니다.
    2. `git commit -F COMMIT_MSG.tmp` 명령어로 커밋합니다.
    3. 성공 시, `del COMMIT_MSG.tmp` 명령어로 임시 파일을 즉시 삭제합니다.

---

## III. 작업 회복성 강화 프로토콜 (신규)

이 프로토콜의 핵심 목표는 **모든 중요한 행동 전후에 명시적인 기록을 남겨**, 제가 어떤 이유로든(모델 전환, 오류 발생 등) 정신을 잃더라도 즉시 현재 상태와 다음 목표를 파악하고 작업을 재개할 수 있도록 하는 것입니다.

앞으로 저는 다음과 같은 절차를 **반드시** 따르겠습니다.

1.  **1단계: 명확한 목표 정의**
    -   "`tasks.py` 수정"과 같이 큰 목표가 아닌, **"`tasks.py`의 `start` 함수에 `doctor.py` 실행 기능 추가"** 와 같이 실행 가능한 가장 작은 단위로 목표를 정의합니다.

2.  **2단계: 실행 전 로그 기록 (Pre-Execution Logging) - ★★★★★**
    -   파일 수정, 명령어 실행 등 중요한 도구를 사용하기 **직전에**, 현재 진행 중인 작업의 `log.md` 파일(`docs/tasks/<현재_작업_ID>/log.md`)에 다음과 같은 내용을 먼저 기록하겠습니다.
        -   **타임스탬프:** 현재 시간
        -   **목표:** 1단계에서 정의한 명확하고 작은 목표
        -   **실행할 작업:** 사용할 도구와 핵심 파라미터 요약 (예: "`write_file`을 사용하여 `tasks.py` 수정 예정")
        -   **변경 내용 요약:** 어떤 부분이 어떻게 바뀔 것인지에 대한 간략한 설명

3.  **3단계: 도구 실행**
    -   로그 기록이 완료된 후에야 실제 도구를 실행합니다.

4.  **4단계: 실행 후 결과 기록 (Post-Execution Logging)**
    -   도구 실행이 **성공**하면, 성공했다는 사실과 그 결과를 `log.md`에 즉시 기록합니다.
    -   만약 **실패**하면, 실패 로그와 오류 내용을 `log.md`에 기록하고, 1단계부터 다시 해결책을 모색합니다.

---

## IV. 주요 문제 해결 (Troubleshooting)

**1. `.gitignore`와 파일 접근 불가**
- **문제:** `.gitignore` 설정으로 인해 특정 파일이 보이지 않거나 접근이 안 될 수 있습니다.
- **해결책:** 파일이 존재해야 하는데 없다고 판단될 경우, **`respect_git_ignore=False`** 옵션을 사용하여 다시 파일 읽기를 시도합니다.

**2. 파일 및 폴더 삭제 안정화 (Python 활용)**

  * **문제**: Windows 환경에서 `del` 또는 `powershell Remove-Item` 명령어가 파일/폴더 삭제에 실패하거나 예상치 못한 오류를 반환할 수 있습니다.
  * **해결책**: Python의 `os.remove()` (파일 삭제) 및 `shutil.rmtree()` (폴더 삭제) 함수를 활용한 스크립트를 실행하여 안정적으로 삭제를 수행합니다.

    > **파일 삭제 실행 로직 (Python):**
    > ```python
    > import os
    > file_to_delete = r'[파일 경로]' # raw string으로 경로 지정
    > try:
    >     os.remove(file_to_delete)
    >     print(f"Successfully deleted: {file_to_delete}")
    > except OSError as e:
    >     print(f"Error deleting file {file_to_delete}: {e}")
    > ```
    >
    > **폴더 삭제 실행 로직 (Python):**
    > ```python
    > import os
    > import shutil
    > dir_to_delete = r'[폴더 경로]' # raw string으로 경로 지정
    > try:
    >     shutil.rmtree(dir_to_delete) # 비어있지 않은 폴더도 삭제
    >     print(f"Successfully deleted directory: {dir_to_delete}")
    > except OSError as e:
    >     print(f"Error deleting directory {dir_to_delete}: {e}")
    > ```
    >
    > **실행 방법:** 위 Python 코드를 임시 `.py` 파일로 저장한 후 `python [임시 파일 경로]` 명령어로 실행합니다.

---

## V. 지능형 작업 기록 시스템 (Intelligent Logging System)

**1. 목적**
- 컨텍스트 손실 없는 완벽한 작업 인계 및 재개를 위함.
- Gemini가 능동적으로 기록을 관리하여 사용자의 부담을 제로(Zero)로 만듦.

**2. 핵심 파일**
- **`docs/HUB.md`:** 모든 작업의 중앙 관제 허브.
- **`docs/tasks/[task_id]/log.md`:** 개별 작업의 상세 타임라인.

**3. 기록 주기 설정 (Logging Cycle Configuration) - ★★★★★**
- **현재 설정: `Standard`**
- Gemini는 아래 설정에 따라 기록 시점을 조절한다. 사용자가 "사이클이 너무 길어/짧아"라고 피드백하면 이 설정을 변경한다.
    - `Detailed`: 파일 수정, 명령어 실행 등 **거의 모든 유의미한 행동 후** 기록을 제안.
    - `Standard` (기본값): 테스트 통과, 기능 구현 완료, 주요 문제 해결 등 **중요한 작업 단위(체크포인트)가 끝났을 때** 기록을 제안.
    - `Minimal`: 사용자가 명시적으로 "기록해줘"라고 하거나, 세션을 종료할 때만 기록.

**4. Gemini 기록 사이클 (Gemini Logging Cycle) - 강제 규칙**

**A. 세션 시작 시:**
1.  **무조건 `docs/HUB.md` 파일을 읽는다.**
2.  HUB의 `Active/Paused Tasks` 목록을 사용자에게 **즉시 브리핑한다.**
    > "현재 진행 중이거나 일시 중지된 작업은 다음과 같습니다: [작업 목록]. 어떤 작업을 계속할까요? 아니면 새로운 작업을 시작할까요?"
    (참고: '일시 중지'와 '진행 중'은 모두 현재 작업 중인 상태로 간주하며, 사용자에게는 통합하여 브리핑합니다.)
3.  `HUB.md`에 `__lastSession__` 블록이 있는지 확인하고, 존재하면 사용자에게 복구 여부를 질문한 후 해당 블록을 삭제한다.

**B. 작업 진행 중 (체크포인트 도달 시):**
1.  현재 설정된 **기록 주기에 따라** 체크포인트 도달을 인지한다.
2.  `git diff`를 사용하여 변경분을 요약하고, 수행한 작업 로그를 생성하여 **먼저 제안하고, 동의를 구한다.**
    > "작업이 완료되었습니다. 다음과 같이 로그에 기록할까요? (Y/N/Edit)"
    - **Attempt Index 규칙**
      - 동일 목표를 재시도할 때, `## 과정` 서브섹션에 1번부터 시작해 **실패마다 +1** 로 번호를 올려 기록한다.
      - 이미 사용한 번호를 다시 쓰지 않는다. (예: 1 → 2 → 3 …)
3.  사용자 피드백을 반영하여 `log.md`에 기록한다. 사용자가 거부하면 기록하지 않되, 다음 체크포인트에서 다시 제안한다.
4.  `HUB.md`의 현재 작업 `lastTouched` 타임스탬프를 갱신하고 커밋을 제안한다.

**C. 세션 종료 시 (사용자가 대화 종료 의사를 밝힐 때):**
1.  **`.gitignore` 복원 확인:** 루트 `.gitignore` 파일에서 `/projects/` 라인의 주석이 제거되었는지 확인하고, 필요시 복원(`replace` 도구 사용)을 제안한다.
    > "세션을 종료하기 전에, `.gitignore` 파일의 `/projects/` 라인 주석을 복원할까요?"
2.  **미커밋 검사 및 WIP 커밋 제안:** `git status`를 실행하여 `dirty tree`를 확인하고, 변경사항이 있으면 `WIP: Session End Backup` 임시 커밋을 제안한다.
3.  **HUB 업데이트:** 현재 작업 상태를 `Paused`로 갱신한다.
4.  **`__lastSession__` 블록 작성:** 활성 작업이 있는 경우, `HUB.md` 최하단에 `__lastSession__` YAML 블록(활성 작업 ID, 변경된 파일 목록, 타임스탬프 포함)을 추가하여 다음 세션 복구를 위한 컨텍스트를 저장한다.
5.  **최종 보고:** "모든 기록이 저장되었고 환경이 정리되었습니다 – 안전 종료." 라고 확답을 제공한다.

**D. 사용자 지시 기록 (강제 규칙):**
1.  사용자가 "기록해줘" 또는 이와 유사한 명시적인 지시를 내릴 경우, 해당 대화 내용을 `docs/tasks/<현재_작업_ID>/log.md` 파일에 추가한다.
2.  기록 후, `docs/HUB.md`의 `lastTouched` 타임스탬프를 갱신하고 커밋을 제안한다.
3.  **주의:** `GEMINI.md` 자체를 수정하는 것이 아니라, 현재 진행 중인 작업의 `log.md` 파일에 기록하는 것을 의미한다.

---

## VI. 고급 기능 및 예외 처리

### 1. NLP Alias 규칙 명문화

사용자의 자연어 명령을 제가 어떻게 해석하고 어떤 표준 운영 절차(SOP)로 매핑하는지 명확히 정의하여 투명성을 확보합니다.

| 사용자 발화 예시 (자연어) | 저의 해석 (내부 명령) | 대응 절차 (SOP) |
| :--- | :--- | :--- |
| "시작!", "왔어", "뭐하지?" | `g start` | **SOP-1 (세션 시작)** |
| "잠깐 멈춰", "pause" | `g pause` | **SOP-2 (작업 상태 변경)** |
| "다시 하자", "resume" | `g resume` | **SOP-2 (작업 상태 변경)** |
| "끝내자", "퇴근", "종료" | `g end` | **SOP-3 (세션 종료)** |
| "되돌려줘", "undo", "롤백" | `g rollback` | **SOP-4 (롤백)** |

### 2. 간소화된 Post-mortem 프로세스

치명적인 오류 발생 시, 완전 자동화를 고집하는 대신 다음과 같은 간소화된 절차를 따르겠습니다.

1.  오류를 감지하면, `write_file` 도구를 사용하여 `docs/tasks/<task-id>/postmortem-YYYYMMDD.md` 파일을 생성합니다.
2.  파일에는 `# Post-mortem - YYYY-MM-DD` 와 같은 기본 헤더만 기록합니다.
3.  사용자에게 "오류 분석을 위해 `[파일 경로]`에 Post-mortem 파일을 생성했습니다. 관련 오류 로그나 상황 설명을 붙여넣어 주세요." 라고 명확히 안내합니다.

### 3. CI 연동 문구 공식화

`GEMINI.md` 가이드의 '규칙 수정' 관련 섹션에 아래 문장을 명시적으로 추가하여, CI/CD 파이프라인과의 연동을 공식화하겠습니다.

> "본 가이드의 수정 사항은 Pull Request 생성 시 `gemini-lint.yml` 워크플로우에 의해 자동으로 검증됩니다."

### 4. 기록 정정 프로세스 (Log Correction)

*   이미 커밋된 로그에 오류가 발견된 경우, 다음 절차에 따라 수정합니다.
*   **규칙:** 기존 로그를 삭제하거나 수정하지 않고, **변경 이력을 보존하기 위해** 그 아래에 수정 내용을 추가합니다.
    > **로그 파일에 추가할 내용 예시:**
    > ```
    > (여기에 수정된 내용 작성)
    > ```
*   수정 후에는 `fix(log): [task-id]의 로그 기록 수정` 형식으로 커밋을 제안합니다.

### 5. 자가 개선 제안 프로토콜 (Meta-Learning Protocol)

*   문제 해결 과정에서 배운 점을 영구적인 지식으로 전환하기 위해 다음 프로토콜을 따릅니다.
    1.  **상황 인지 (Trigger) 정교화:**
        *   **'규칙 제안' 트리거 (기존):** 동일한 목표를 가진 명령이 **2회 이상 연속 실패** 후, 다른 접근 방식으로 **1회 성공**했을 경우.
        *   **'규칙 제안' 트리거 (추가/수정):**
            *   **새로운 규칙 제안:** 대화 중 저의 행동이 `GEMINI.md`의 지침을 충분히 따르지 못했거나, 사용자에게 더 나은 경험을 제공할 수 있는 새로운 프로세스/규칙이 필요하다고 판단될 경우, 즉시 사용자에게 `GEMINI.md` 업데이트를 제안합니다.
            *   **기존 규칙 명확화/강화 제안:** 기존 `GEMINI.md` 규칙의 해석에 모호함이 있었거나, 더 강력한 자동화/선제적 조치가 필요하다고 판단될 경우, 즉시 사용자에게 해당 규칙의 명확화 또는 강화를 제안합니다.
        *   **'규칙 확정' 트리거:** 새로운 성공 방식이 **3회 이상 문제없이 연속 성공**했을 경우.
    2.  **규칙 업데이트 제안:** 위 트리거 조건 충족 시, 성공한 해결책을 `GEMINI.md`에 추가/확정할 것을 사용자에게 제안합니다.

---

## VII. 변경 이력 (Changelog)

*   **v1.3 (2025-07-22):** 자가 개선(Meta-Learning) 프로토콜, 로그 정정 SOP, PowerShell 기반 안정적 파일 삭제, 상세 과정 로깅 규칙 추가.

---

## VIII. 파일 및 폴더 관리 정책

**1. 사용되지 않는 파일/폴더 식별 및 처리**
- **목적:** 워크스페이스의 불필요한 파일 및 폴더를 정리하여 가독성을 높이고, Git 저장소의 크기를 효율적으로 관리합니다.
- **식별 기준:**
    - 더 이상 사용되지 않는 코드 파일, 스크립트, 설정 파일.
    - 완료된 작업의 임시 파일 또는 백업본.
    - 프로젝트에서 제외되었거나, 다른 곳으로 이동된 파일/폴더.
- **처리 절차 (임시 보관 후 삭제):**
    1.  **임시 보관 디렉토리 생성:** `archive/` 또는 `trash/`와 같은 임시 보관 디렉토리를 프로젝트 루트에 생성합니다.
    2.  **파일 이동:** 사용되지 않는다고 판단되는 파일/폴더를 해당 임시 보관 디렉토리로 이동합니다.
    3.  **Git 추적 제외 (필요시):** 임시 보관 디렉토리가 `.gitignore`에 포함되어 Git 추적에서 제외되는지 확인합니다. (일반적으로 `archive/`나 `trash/`는 `.gitignore`에 추가됩니다.)
    4.  **일정 기간 유지:** 이동된 파일/폴더를 일정 기간(예: 30일) 동안 유지하여, 혹시 모를 필요성에 대비합니다.
    5.  **영구 삭제:** 일정 기간이 경과한 후, 사용자에게 확인을 거쳐 영구적으로 삭제합니다.

**2. 파일 정리 시 주의사항**
- **Git 기록 보존:** 중요한 파일의 경우, Git 기록을 보존하기 위해 `git rm` 명령어를 사용하거나, 삭제 전 커밋을 남깁니다.
- **사용자 확인:** 중요한 파일이나 폴더를 삭제하기 전에는 반드시 사용자에게 확인을 요청합니다.
- **백업:** 중요한 변경 전에는 항상 백업을 수행합니다.